<section class="hero" *ngIf="!isLoading() && heroPhone() as hp; else loadingTpl">
  <div class="hero__bg"></div>
  <div class="hero__content">
    <div class="hero__badge">New arrival</div>
    <h1 class="hero__title">{{ hp.brand.name }} {{ hp.model }}</h1>
    <p class="hero__subtitle">Precision engineered flagship with uncompromising performance.</p>

    <ul class="hero__specs" *ngIf="heroSpecs().length">
      <li *ngFor="let spec of heroSpecs()">{{ spec }}</li>
    </ul>

    <div class="hero__cta">
      <button class="btn btn--primary" (click)="scrollToCatalogue()">Shop now</button>
      <button class="btn btn--ghost" (click)="toggleCart()">View cart</button>
    </div>

    <div class="hero__price">{{ hp.price | currency }}</div>
  </div>
</section>

<ng-template #loadingTpl>
  <section class="loading" *ngIf="isLoading(); else emptyStateTpl">
    <div class="spinner"></div>
    <div>Preparing your showroom…</div>
  </section>
</ng-template>

<ng-template #emptyStateTpl>
  <section class="hero">
    <div class="hero__bg"></div>
    <div class="hero__content">
      <div class="hero__badge">Showroom</div>
      <h1 class="hero__title">Your modern phone showroom</h1>
      <p class="hero__subtitle">Connect to the catalogue to see featured devices and live metrics.</p>
      <div class="hero__cta">
        <button class="btn btn--primary" (click)="scrollToCatalogue()">Explore catalogue</button>
        <button class="btn btn--ghost" (click)="reloadData()">Refresh</button>
      </div>
    </div>
  </section>
</ng-template>

<section class="error" *ngIf="!isLoading() && error()">
  <p>{{ error() }}</p>
</section>

<section class="metrics" *ngIf="!isLoading() && !error() && metrics().length">
  <div class="metrics__grid">
    <div class="metric" *ngFor="let m of metrics()">
      <div class="metric__value" [ngClass]="{'is-currency': m.kind === 'currency'}">
        <ng-container [ngSwitch]="m.kind">
          <span *ngSwitchCase="'currency'">{{ m.value | currency }}</span>
          <span *ngSwitchCase="'percentage'">{{ m.value | number:'1.0-0' }}%</span>
          <span *ngSwitchDefault>{{ m.value | number:'1.0-0' }}<span *ngIf="m.suffix">{{ m.suffix }}</span></span>
        </ng-container>
      </div>
      <div class="metric__label">{{ m.label }}</div>
    </div>
  </div>
</section>

<section class="highlights" *ngIf="!isLoading() && !error()">
  <div class="highlights__grid">
    <article class="highlight" *ngFor="let h of curatedHighlights()">
      <h3>{{ h.title }}</h3>
      <p>{{ h.caption }}</p>
    </article>
  </div>
</section>

<section class="products" id="catalogue" *ngIf="!isLoading() && !error()">
  <div class="controls">
    <input
      class="control control--search"
      type="search"
      placeholder="Search models or specs"
      [value]="searchQuery()"
      (input)="onSearch($any($event.target).value)"
    />
    <div class="control control--brands">
      <button class="chip" [ngClass]="{'is-active': selectedBrand() === null}" (click)="selectBrand(null)">All</button>
      <button class="chip" *ngFor="let b of brands()" [ngClass]="{'is-active': selectedBrand() === b.name}" (click)="selectBrand(b.name)">{{ b.name }}</button>
    </div>
    <select class="control control--sort" [value]="sortKey()" (change)="setSort($any($event.target).value)">
      <option value="relevance">Sort: Relevance</option>
      <option value="priceAsc">Price: Low to High</option>
      <option value="priceDesc">Price: High to Low</option>
      <option value="nameAsc">Name: A → Z</option>
    </select>
    <button class="cart-toggle" (click)="toggleCart()">
      <span>Cart</span>
      <span class="cart-toggle__count">{{ cartCount() }}</span>
    </button>
  </div>
  <div class="section-head">
    <h2>Featured</h2>
    <p>Hand-picked devices for a frictionless start.</p>
  </div>
  <div class="products__grid products__grid--featured">
    <article class="card card--featured" *ngFor="let phone of filteredFeatured(); trackBy: trackPhoneById">
      <div class="card__thumb">
        <div class="thumb__bg"></div>
        <div class="thumb__fx"></div>
        <div class="thumb__label">{{ phone.brand.name }}</div>
      </div>
      <div class="card__body">
        <h4 class="card__title">{{ phone.model }}</h4>
        <div class="card__meta">
          <span class="price">{{ phone.price | currency }}</span>
          <span class="stock" [ngClass]="{'in': phone.stock > 0, 'out': phone.stock === 0}">
            {{ phone.stock > 0 ? (phone.stock + ' in stock') : 'Out of stock' }}
          </span>
        </div>
        <div class="card__actions">
          <button class="btn btn--primary" (click)="addToCart(phone)">Add to cart</button>
          <button class="btn btn--ghost" (click)="openDetails(phone)">Details</button>
        </div>
      </div>
    </article>
  </div>

  <div class="section-head">
    <h2>Catalogue</h2>
    <p>Explore the full lineup across brands and segments.</p>
  </div>
  <div class="products__grid">
    <article class="card" *ngFor="let phone of paginatedRemaining(); trackBy: trackPhoneById">
      <div class="card__thumb">
        <div class="thumb__bg"></div>
        <div class="thumb__label">{{ phone.brand.name }}</div>
      </div>
      <div class="card__body">
        <h4 class="card__title">{{ phone.model }}</h4>
        <div class="card__meta">
          <span class="price">{{ phone.price | currency }}</span>
          <span class="stock" [ngClass]="{'in': phone.stock > 0, 'out': phone.stock === 0}">
            {{ phone.stock > 0 ? (phone.stock + ' in stock') : 'Out of stock' }}
          </span>
        </div>
        <div class="card__actions">
          <button class="btn btn--ghost" (click)="openDetails(phone)">View details</button>
          <button class="btn btn--primary" (click)="addToCart(phone)">Add</button>
        </div>
      </div>
    </article>
  </div>
  <div class="pagination" *ngIf="pageCount() > 1">
    <button class="pager" (click)="prevPage()" [disabled]="pageIndex() === 0">Prev</button>
    <button
      class="pager"
      *ngFor="let i of pageNumbers()"
      [ngClass]="{'is-active': pageIndex() === i}"
      (click)="setPage(i)"
    >
      {{ i + 1 }}
    </button>
    <button class="pager" (click)="nextPage()" [disabled]="pageIndex() >= pageCount() - 1">Next</button>
  </div>
</section>

<section class="admin" *ngIf="!isLoading() && !error()">
  <div class="section-head">
    <h2>Catalogue Console</h2>
    <p>Enrich the showcase with verified brands and flagship devices without leaving the front end.</p>
  </div>

  <div class="admin__grid">
    <form class="panel" (ngSubmit)="submitBrand()" novalidate>
      <h3>Add a brand</h3>
      <p class="panel__hint">Only established manufacturers are permitted.</p>

      <label class="form-label" for="brandName">Select brand</label>
      <select
        id="brandName"
        name="brandName"
        class="form-control"
        required
        [(ngModel)]="brandForm.name"
      >
        <option value="" disabled>Select a brand</option>
        <option
          *ngFor="let option of realBrandOptions"
          [value]="option"
          [disabled]="isBrandPresent(option)"
        >
          {{ option }}
        </option>
      </select>

      <div class="form-help" *ngIf="!availableBrandOptions().length">
        All supported brands are already present.
      </div>

      <div class="form-error" *ngIf="brandError() as brandErr">{{ brandErr }}</div>

      <button class="btn btn--primary btn--block" type="submit" [disabled]="brandSubmitting()">
        <span *ngIf="brandSubmitting(); else brandCta">Adding…</span>
        <ng-template #brandCta>Add brand</ng-template>
      </button>
    </form>

    <form class="panel" (ngSubmit)="submitPhone()" novalidate>
      <h3>Add a device</h3>
      <p class="panel__hint">Associate the model with an existing brand and validate launch details.</p>

      <label class="form-label" for="phoneBrand">Brand</label>
      <select
        id="phoneBrand"
        name="phoneBrand"
        class="form-control"
        required
        [(ngModel)]="phoneForm.brandId"
      >
        <option value="" disabled>Select brand</option>
        <option *ngFor="let brand of brands()" [value]="brand.id">{{ brand.name }}</option>
      </select>

      <label class="form-label" for="phoneModel">Model</label>
      <input
        id="phoneModel"
        name="phoneModel"
        class="form-control"
        type="text"
        required
        minlength="3"
        [pattern]="phoneModelPattern"
        placeholder="e.g. Galaxy S24 Ultra"
        [(ngModel)]="phoneForm.model"
      />

      <label class="form-label" for="phonePrice">Launch price</label>
      <input
        id="phonePrice"
        name="phonePrice"
        class="form-control"
        type="number"
        step="0.01"
        min="0"
        placeholder="999.99"
        [(ngModel)]="phoneForm.price"
      />

      <label class="form-label" for="phoneStock">Initial stock</label>
      <input
        id="phoneStock"
        name="phoneStock"
        class="form-control"
        type="number"
        min="0"
        step="1"
        placeholder="20"
        [(ngModel)]="phoneForm.stock"
      />

      <label class="form-label" for="phoneSpecs">Key specs</label>
      <textarea
        id="phoneSpecs"
        name="phoneSpecs"
        class="form-control form-control--textarea"
        rows="4"
        placeholder="6.7” OLED, 12GB RAM, 256GB, 5000mAh, 48MP"
        [(ngModel)]="phoneForm.specs"
      ></textarea>

      <div class="form-error" *ngIf="phoneError() as phoneErr">{{ phoneErr }}</div>

      <button class="btn btn--primary btn--block" type="submit" [disabled]="phoneSubmitting()">
        <span *ngIf="phoneSubmitting(); else phoneCta">Publishing…</span>
        <ng-template #phoneCta>Add device</ng-template>
      </button>
    </form>
  </div>
</section>

<section class="brands" *ngIf="!isLoading() && !error()">
  <div class="brands__marquee">
    <div class="marquee__track">
      <span class="brand" *ngFor="let b of marqueeBrands(); trackBy: trackBrandByName">{{ b }}</span>
    </div>
  </div>
</section>

<!-- Details Modal -->
<section class="modal" *ngIf="selectedPhone() as sp">
  <div class="modal__backdrop" (click)="closeDetails()"></div>
  <div class="modal__panel" role="dialog" aria-modal="true">
    <header class="modal__header">
      <h3>{{ sp.brand.name }} {{ sp.model }}</h3>
      <button class="modal__close" (click)="closeDetails()">×</button>
    </header>
    <div class="modal__content">
      <div class="modal__price">{{ sp.price | currency }}</div>
      <div class="modal__specs" *ngIf="specList(sp.specs) as specs">
        <ul>
          <li *ngFor="let spec of specs">{{ spec }}</li>
        </ul>
      </div>
    </div>
    <footer class="modal__footer">
      <button class="btn btn--primary" (click)="addToCart(sp)">Add to cart</button>
      <button class="btn btn--ghost" (click)="closeDetails()">Close</button>
    </footer>
  </div>
 </section>

<!-- Toast -->
<div class="toast" *ngIf="toastMessage() as tm">{{ tm }}</div>

<!-- Cart Drawer -->
<section class="cart" [ngClass]="{'is-open': isCartOpen()}">
  <div class="cart__overlay" (click)="closeCart()"></div>
  <aside class="cart__panel">
    <header class="cart__header">
      <h3>Cart ({{ cartCount() }})</h3>
      <button class="cart__close" (click)="closeCart()">×</button>
    </header>
    <div class="cart__body" *ngIf="cartItems().length; else emptyCart">
      <article class="cart__item" *ngFor="let item of cartItems()">
        <div>
          <div class="cart__item-title">{{ item.phone.brand.name }} {{ item.phone.model }}</div>
          <div class="cart__item-price">{{ item.phone.price | currency }}</div>
        </div>
        <div class="cart__item-actions">
          <button (click)="decrementCartItem(item.phone)">−</button>
          <span>{{ item.quantity }}</span>
          <button (click)="incrementCartItem(item.phone)">+</button>
          <button class="remove" (click)="removeFromCart(item.phone)">Remove</button>
        </div>
      </article>
    </div>
    <ng-template #emptyCart>
      <div class="cart__empty">No items yet. Add flagship devices to preview checkout.</div>
    </ng-template>
    <footer class="cart__footer">
      <div class="cart__total">Total {{ cartTotal() | currency }}</div>
      <button class="btn btn--primary" [disabled]="!cartItems().length">Checkout preview</button>
      <button class="btn btn--ghost" [disabled]="!cartItems().length" (click)="clearCart()">Clear cart</button>
    </footer>
  </aside>
</section>
